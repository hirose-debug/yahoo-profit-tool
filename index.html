<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°åˆ©ç›Šè¨ˆç®—è¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="bg-gradient-to-r from-red-500 to-orange-600 text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-3xl font-bold"><span id="headerYear">2026å¹´</span> <span id="headerMonth">1æœˆ</span></h1>
                <h2 class="text-xl">Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°åˆ©ç›Šè¨ˆç®—è¡¨</h2>
            </div>
            <div class="flex gap-2">
                <select id="yearSelect" class="px-4 py-2 bg-white text-gray-800 rounded shadow font-semibold">
                    <option value="2024">2024å¹´</option>
                    <option value="2025">2025å¹´</option>
                    <option value="2026" selected>2026å¹´</option>
                    <option value="2027">2027å¹´</option>
                </select>
                <button onclick="openUploadModal()" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded shadow font-semibold">
                    + ãƒ‡ãƒ¼ã‚¿ç™»éŒ²
                </button>
                <button onclick="generateMonthlyReport()" class="px-6 py-2 bg-purple-500 hover:bg-purple-600 rounded shadow font-semibold">
                    ğŸ“„ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
                </button>
                <button onclick="exportProductData()" class="px-6 py-2 bg-teal-500 hover:bg-teal-600 rounded shadow font-semibold">
                    ğŸ’¾ å•†å“ãƒ‡ãƒ¼ã‚¿
                </button>
                <button onclick="openCostEditModal()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded shadow font-semibold">
                    âœï¸ åŸä¾¡ç·¨é›†
                </button>
                <button onclick="openBackupModal()" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 rounded shadow font-semibold">
                    ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                </button>
                <button onclick="openSpreadsheetModal()" class="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 rounded shadow font-semibold">
                    ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ
                </button>
                <button onclick="resetAllData()" class="px-6 py-2 bg-red-500 hover:bg-red-600 rounded shadow font-semibold">
                    ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6">
        <!-- ã‚µãƒãƒªãƒ¼ -->
        <div class="grid grid-cols-10 gap-3 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">å£²ä¸Š</div>
                <div class="text-2xl font-bold" id="totalSales">Â¥0</div>
                <div class="text-xs text-gray-500" id="salesPercentage">(+0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">æ‰‹æ•°æ–™</div>
                <div class="text-2xl font-bold text-red-600" id="totalCommission">Â¥0</div>
                <div class="text-xs text-gray-500" id="commissionRate">(11%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>é€æ–™</span>
                    <button onclick="adjustShipping()" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold text-red-600" id="totalShipping">Â¥0</div>
                <div class="text-xs text-gray-500" id="shippingRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">åºƒå‘Šè²»</div>
                <div class="text-2xl font-bold text-red-600" id="totalAds">Â¥0</div>
                <div class="text-xs text-gray-500" id="adsRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>PRã‚ªãƒ—ã‚·ãƒ§ãƒ³</span>
                    <button onclick="adjustProption()" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold text-red-600" id="totalProption">Â¥0</div>
                <div class="text-xs text-gray-500" id="proptionRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ</span>
                    <button onclick="adjustAffiliate()" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold text-red-600" id="totalAffiliate">Â¥0</div>
                <div class="text-xs text-gray-500" id="affiliateRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">ä»•å…¥åŸä¾¡</div>
                <div class="text-2xl font-bold text-red-600" id="totalCost">Â¥0</div>
                <div class="text-xs text-gray-500" id="costRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>å€‰åº«ä¿ç®¡æ–™ç­‰</span>
                    <button onclick="adjustOtherExpense()" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold text-red-600" id="totalOther">Â¥0</div>
                <div class="text-xs text-gray-500" id="otherRate">(0%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>èª¿æ•´é¡</span>
                    <button onclick="adjustAdjustment()" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold" id="totalAdjustment">Â¥0</div>
                <div class="text-xs text-gray-500" id="adjustmentRate">(-0.03%)</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">åˆ©ç›Š</div>
                <div class="text-2xl font-bold text-blue-600" id="totalProfit">Â¥0</div>
                <div class="text-xs text-gray-500" id="profitRate">(0%)</div>
            </div>
        </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1 flex justify-between items-center">
                    <span>èª¿æ•´é¡</span>
                    <button onclick="toggleEditMode('adjustment')" class="text-xs text-blue-600">âœï¸</button>
                </div>
                <div class="text-2xl font-bold" id="totalAdjustment">Â¥0</div>
                <div class="text-xs text-gray-500" id="adjustmentRate">(0%)</div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg shadow">
                <div class="text-sm text-gray-600 mb-1">åˆ©ç›Š</div>
                <div class="text-2xl font-bold text-orange-600" id="totalProfit">Â¥0</div>
                <div class="text-xs text-gray-500" id="profitRate">(0%)</div>
            </div>
        </div>

        <!-- å‰å¹´åŒæœˆãƒ»å‰æœˆæ¯”è¼ƒ -->
        <div class="bg-white p-4 rounded-lg shadow mb-6" id="comparisonSection" style="display:none;">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-sm text-gray-600 mb-2">æ˜¨å¹´åŒæœˆ</div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-semibold" id="lastYearSales">Â¥0</span>
                        <span class="text-sm" id="lastYearComparison">(+0%)</span>
                    </div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-2">å‰æœˆ</div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-semibold" id="lastMonthSales">Â¥0</span>
                        <span class="text-sm" id="lastMonthComparison">(+0%)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœˆé¸æŠ -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <div class="grid grid-cols-12 gap-2" id="monthSelector"></div>
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="flex gap-2 mb-4">
            <button onclick="switchTab('products')" class="tab-btn px-6 py-3 rounded-t font-bold bg-orange-600 text-white">å•†å“åˆ¥åˆ©ç›Š</button>
            <button onclick="switchTab('transition')" class="tab-btn px-6 py-3 rounded-t font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">æ¨ç§»è¡¨</button>
            <button onclick="switchTab('graph')" class="tab-btn px-6 py-3 rounded-t font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">ã‚°ãƒ©ãƒ•</button>
            <button onclick="switchTab('ranking')" class="tab-btn px-6 py-3 rounded-t font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
        </div>

        <!-- å•†å“åˆ¥åˆ©ç›Šã‚¿ãƒ– -->
        <div id="products" class="tab-content active">
            <div class="bg-white p-4 rounded-lg shadow mb-4" id="searchBar" style="display:none;">
                <div class="flex gap-4 items-center">
                    <input type="text" id="searchInput" placeholder="å•†å“åã¾ãŸã¯å•†å“ã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢..." 
                           class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
                    <div class="text-sm text-gray-600" id="searchCount">0 / 0 ä»¶è¡¨ç¤º</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3 text-left">å•†å“ã‚³ãƒ¼ãƒ‰</th>
                            <th class="p-3 text-left">å•†å“å</th>
                            <th class="p-3 text-right cursor-pointer hover:bg-gray-200" onclick="sortTable('price')">è²©å£²å˜ä¾¡ â†•</th>
                            <th class="p-3 text-right cursor-pointer hover:bg-gray-200" onclick="sortTable('sales')">å£²ä¸Š â†•</th>
                            <th class="p-3 text-right cursor-pointer hover:bg-gray-200" onclick="sortTable('quantity')">æ³¨æ–‡æ•° â†•</th>
                            <th class="p-3 text-right">æ‰‹æ•°æ–™</th>
                            <th class="p-3 text-right">é€æ–™</th>
                            <th class="p-3 text-right">åºƒå‘Šè²»</th>
                            <th class="p-3 text-right">ä»•å…¥åŸä¾¡</th>
                            <th class="p-3 text-right">ãã®ä»–</th>
                            <th class="p-3 text-right cursor-pointer hover:bg-gray-200" onclick="sortTable('access')">PVæ•° â†•</th>
                            <th class="p-3 text-right cursor-pointer hover:bg-gray-200" onclick="sortTable('profit')">åˆ©ç›Š â†•</th>
                            <th class="p-3 text-right">åˆ©ç›Šç‡</th>
                            <th class="p-3 text-right">åºƒå‘ŠæŠœã<br>åˆ©ç›Šç‡</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- æ¨ç§»è¡¨ã‚¿ãƒ– -->
        <div id="transition" class="tab-content">
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3 text-left">å¹´æœˆ</th>
                            <th class="p-3 text-right">å£²ä¸Š</th>
                            <th class="p-3 text-right">æ‰‹æ•°æ–™</th>
                            <th class="p-3 text-right">é€æ–™</th>
                            <th class="p-3 text-right">åºƒå‘Šè²»</th>
                            <th class="p-3 text-right">PRã‚ªãƒ—ã‚·ãƒ§ãƒ³</th>
                            <th class="p-3 text-right">ä»•å…¥åŸä¾¡</th>
                            <th class="p-3 text-right">ãã®ä»–</th>
                            <th class="p-3 text-right">èª¿æ•´é¡</th>
                            <th class="p-3 text-right">åˆ©ç›Š</th>
                            <th class="p-3 text-right">åˆ©ç›Šç‡</th>
                        </tr>
                    </thead>
                    <tbody id="transitionTable"></tbody>
                </table>
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
        <div id="graph" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <canvas id="profitChart" height="100"></canvas>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¿ãƒ– -->
        <div id="ranking" class="tab-content">
            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">å£²ä¸ŠTOP10</h3>
                    <div id="salesRanking"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-bold mb-4">åˆ©ç›ŠTOP10</h3>
                    <div id="profitRanking"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-bold mb-6">ãƒ‡ãƒ¼ã‚¿ç™»éŒ²</h2>
            
            <div class="space-y-4">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <label class="block mb-2 font-semibold">1. å£²ä¸ŠCSVï¼ˆYahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼‰</label>
                    <input type="file" id="salesFile" accept=".csv" class="w-full">
                    <p class="text-sm text-gray-500 mt-2">å•†å“åˆ¥å£²ä¸Šãƒ»ã‚¢ã‚¯ã‚»ã‚¹ãƒ‡ãƒ¼ã‚¿</p>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">å¯¾è±¡å¹´æœˆ</label>
                        <div class="flex gap-2">
                            <select id="salesYear" class="px-3 py-2 border rounded">
                                <option value="2024">2024å¹´</option>
                                <option value="2025">2025å¹´</option>
                                <option value="2026" selected>2026å¹´</option>
                                <option value="2027">2027å¹´</option>
                            </select>
                            <select id="salesMonth" class="px-3 py-2 border rounded">
                                <option value="1">1æœˆ</option>
                                <option value="2">2æœˆ</option>
                                <option value="3">3æœˆ</option>
                                <option value="4">4æœˆ</option>
                                <option value="5">5æœˆ</option>
                                <option value="6">6æœˆ</option>
                                <option value="7">7æœˆ</option>
                                <option value="8">8æœˆ</option>
                                <option value="9">9æœˆ</option>
                                <option value="10">10æœˆ</option>
                                <option value="11">11æœˆ</option>
                                <option value="12">12æœˆ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <label class="block mb-2 font-semibold">2. åºƒå‘Šè²»CSVï¼ˆYahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ï¼‰</label>
                    <input type="file" id="adsFile" accept=".csv" class="w-full">
                    <p class="text-sm text-gray-500 mt-2">å•†å“åˆ¥åºƒå‘Šè²»ãƒ‡ãƒ¼ã‚¿</p>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <label class="block mb-2 font-semibold">3. åŸä¾¡ãƒ»çµŒè²»CSV/Excel</label>
                    <input type="file" id="costFile" accept=".csv,.xlsx,.xls" class="w-full">
                    <p class="text-sm text-gray-500 mt-2">Båˆ—:å•†å“ã‚³ãƒ¼ãƒ‰ã€Påˆ—:åŸä¾¡ã€Våˆ—:é€æ–™</p>
                    <div class="mt-2 text-sm" id="costStatus">æœªç™»éŒ²</div>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="processUpload()" class="flex-1 bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700">
                    ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿
                </button>
                <button onclick="clearUploadFiles()" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600">
                    ã‚¯ãƒªã‚¢
                </button>
                <button onclick="closeUploadModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>

    <!-- åŸä¾¡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="costEditModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">åŸä¾¡ãƒ»é€æ–™ç·¨é›†</h2>
            <div class="mb-4">
                <input type="text" id="costSearchInput" placeholder="å•†å“ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯å•†å“åã§æ¤œç´¢..." 
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3 text-left">å•†å“ã‚³ãƒ¼ãƒ‰</th>
                            <th class="p-3 text-left">å•†å“å</th>
                            <th class="p-3 text-right">åŸä¾¡</th>
                            <th class="p-3 text-right">é€æ–™</th>
                            <th class="p-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="costEditTable"></tbody>
                </table>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="closeCostEditModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="backupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-bold mb-6">ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
            
            <div class="space-y-4">
                <div class="border-2 border-gray-300 rounded-lg p-6">
                    <h3 class="font-semibold mb-3">ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
                    <p class="text-sm text-gray-600 mb-4">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</p>
                    <button onclick="downloadBackup()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                        ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <h3 class="font-semibold mb-3">ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ</h3>
                    <p class="text-sm text-gray-600 mb-4">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™</p>
                    <input type="file" id="backupFile" accept=".json" class="w-full mb-3">
                    <button onclick="restoreBackup()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
                        ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒ
                    </button>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="closeBackupModal()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="spreadsheetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6">Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº</h2>
            
            <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-gray-700">
                    <strong>âš ï¸ äº‹å‰æº–å‚™ãŒå¿…è¦ã§ã™</strong><br>
                    Google Apps Script (GAS) ã®Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
                    <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">Google Apps Script</a>
                </p>
            </div>

            <div class="space-y-4">
                <div class="border-2 border-gray-300 rounded-lg p-6">
                    <h3 class="font-semibold mb-3">GAS Webã‚¢ãƒ—ãƒªURL</h3>
                    <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3">
                    <button onclick="saveGasUrl()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                        URL ã‚’ä¿å­˜
                    </button>
                    <div class="mt-2 text-sm" id="gasUrlStatus"></div>
                </div>

                <div class="border-2 border-gray-300 rounded-lg p-6">
                    <h3 class="font-semibold mb-3">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ä¿å­˜</h3>
                    <p class="text-sm text-gray-600 mb-4">ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™</p>
                    <button onclick="saveToSpreadsheet()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700">
                        ğŸ“¤ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ä¿å­˜
                    </button>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <h3 class="font-semibold mb-3">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿</h3>
                    <p class="text-sm text-gray-600 mb-4">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™</p>
                    <div class="flex gap-2 mb-3">
                        <select id="loadYear" class="px-3 py-2 border rounded">
                            <option value="2024">2024å¹´</option>
                            <option value="2025">2025å¹´</option>
                            <option value="2026" selected>2026å¹´</option>
                            <option value="2027">2027å¹´</option>
                        </select>
                        <select id="loadMonth" class="px-3 py-2 border rounded">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <button onclick="loadFromSpreadsheet()" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700">
                        ğŸ“¥ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿
                    </button>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="closeSpreadsheetModal()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentYear = '2026';
        let currentMonth = '1æœˆ';
        let monthlyData = {};
        let rawData = {
            sales: {},
            ads: {},
            cost: {}
        };
        let adjustments = {};
        let uploadStatus = {
            sales: false,
            ads: false,
            cost: false
        };

        const COMMISSION_RATE = 0.11; // Yahoo!ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°æ‰‹æ•°æ–™ 11%

        // åˆæœŸåŒ–
        initMonthSelector();
        loadFromStorage();

        function initMonthSelector() {
            const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = months.map(month => 
                `<button onclick="selectMonth('${month}')" 
                    class="month-btn px-4 py-3 rounded font-bold transition
                    ${month === currentMonth ? 'bg-orange-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}"
                >${month}</button>`
            ).join('');
        }

        function selectMonth(month) {
            currentMonth = month;
            document.getElementById('headerMonth').textContent = month;
            initMonthSelector();
            updateDisplay();
            updateComparison();
        }

        function getAdjustments(year, month) {
            if (!adjustments[year]) adjustments[year] = {};
            if (!adjustments[year][month]) {
                adjustments[year][month] = {
                    shipping: 0,
                    proption: 0,
                    other: 0,
                    adjustment: 0
                };
            }
            return adjustments[year][month];
        }

        function updateDisplay() {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            const adj = getAdjustments(currentYear, currentMonth);
            
            const totals = products.reduce((acc, p) => ({
                sales: acc.sales + (p.sales || 0),
                commission: acc.commission + (p.commission || 0),
                shipping: acc.shipping + (p.shipping || 0),
                ads: acc.ads + (p.ads || 0),
                proption: acc.proption + (p.proption || 0),
                affiliate: acc.affiliate + (p.affiliate || 0),
                cost: acc.cost + (p.cost || 0),
                other: acc.other + (p.other || 0)
            }), { sales: 0, commission: 0, shipping: 0, ads: 0, proption: 0, affiliate: 0, cost: 0, other: 0 });

            totals.shipping += adj.shipping || 0;
            totals.proption += adj.proption || 0;
            totals.affiliate += adj.affiliate || 0;
            totals.other += adj.other || 0;
            const totalAdjustment = adj.adjustment || 0;
            
            const profit = totals.sales - totals.commission - totals.shipping - totals.ads - totals.proption - totals.affiliate - totals.cost - totals.other + totalAdjustment;

            document.getElementById('totalSales').textContent = formatCurrency(totals.sales);
            document.getElementById('totalCommission').textContent = formatCurrency(totals.commission);
            document.getElementById('totalShipping').textContent = formatCurrency(totals.shipping);
            document.getElementById('totalAds').textContent = formatCurrency(totals.ads);
            document.getElementById('totalProption').textContent = formatCurrency(totals.proption);
            document.getElementById('totalAffiliate').textContent = formatCurrency(totals.affiliate);
            document.getElementById('totalCost').textContent = formatCurrency(totals.cost);
            document.getElementById('totalOther').textContent = formatCurrency(totals.other);
            document.getElementById('totalAdjustment').textContent = formatCurrency(totalAdjustment);
            document.getElementById('totalProfit').textContent = formatCurrency(profit);

            document.getElementById('commissionRate').textContent = `(11%)`;
            document.getElementById('shippingRate').textContent = totals.sales > 0 ? `(${(totals.shipping/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('adsRate').textContent = totals.sales > 0 ? `(${(totals.ads/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('proptionRate').textContent = totals.sales > 0 ? `(${(totals.proption/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('affiliateRate').textContent = totals.sales > 0 ? `(${(totals.affiliate/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('costRate').textContent = totals.sales > 0 ? `(${(totals.cost/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('otherRate').textContent = totals.sales > 0 ? `(${(totals.other/totals.sales*100).toFixed(1)}%)` : '(0%)';
            document.getElementById('profitRate').textContent = totals.sales > 0 ? `(${(profit/totals.sales*100).toFixed(1)}%)` : '(0%)';

            updateProductsTable();
            updateTransitionTable();
            updateGraph();
            updateRanking();
        }

        function updateProductsTable() {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.id.toLowerCase().includes(searchTerm)
            );

            if (products.length > 0) {
                document.getElementById('searchBar').style.display = 'block';
                document.getElementById('searchCount').textContent = `${filtered.length} / ${products.length} ä»¶è¡¨ç¤º`;
            }

            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = filtered.map(p => {
                const profit = p.sales - p.commission - p.shipping - p.ads - (p.proption || 0) - p.cost - (p.other || 0);
                const profitRate = p.sales > 0 ? (profit / p.sales * 100).toFixed(1) : 0;
                const profitWithoutAds = p.sales - p.commission - p.shipping - p.cost - (p.other || 0);
                const profitRateWithoutAds = p.sales > 0 ? (profitWithoutAds / p.sales * 100).toFixed(1) : 0;
                const unitPrice = p.quantity > 0 ? Math.round(p.sales / p.quantity) : 0;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">${p.id}</td>
                        <td class="p-3">${p.name}</td>
                        <td class="p-3 text-right">${formatCurrency(unitPrice)}</td>
                        <td class="p-3 text-right font-semibold">${formatCurrency(p.sales)}</td>
                        <td class="p-3 text-right">${p.quantity}</td>
                        <td class="p-3 text-right text-red-600">${formatCurrency(p.commission)}</td>
                        <td class="p-3 text-right text-red-600">${formatCurrency(p.shipping)}</td>
                        <td class="p-3 text-right text-red-600">${formatCurrency(p.ads)}</td>
                        <td class="p-3 text-right text-red-600">${formatCurrency(p.cost)}</td>
                        <td class="p-3 text-right">${formatCurrency(p.other || 0)}</td>
                        <td class="p-3 text-right">${p.access || 0}</td>
                        <td class="p-3 text-right font-bold ${profit >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(profit)}</td>
                        <td class="p-3 text-right ${profitRate >= 0 ? 'text-blue-600' : 'text-red-600'}">${profitRate}%</td>
                        <td class="p-3 text-right ${profitRateWithoutAds >= 0 ? 'text-green-600' : 'text-red-600'}">${profitRateWithoutAds}%</td>
                    </tr>
                `;
            }).join('');
        }

        function updateTransitionTable() {
            const tbody = document.getElementById('transitionTable');
            const rows = [];

            for (let year in monthlyData) {
                for (let month in monthlyData[year]) {
                    const products = monthlyData[year][month];
                    const adj = getAdjustments(year, month);
                    
                    const totals = products.reduce((acc, p) => ({
                        sales: acc.sales + (p.sales || 0),
                        commission: acc.commission + (p.commission || 0),
                        shipping: acc.shipping + (p.shipping || 0),
                        ads: acc.ads + (p.ads || 0),
                        proption: acc.proption + (p.proption || 0),
                        cost: acc.cost + (p.cost || 0),
                        other: acc.other + (p.other || 0)
                    }), { sales: 0, commission: 0, shipping: 0, ads: 0, proption: 0, cost: 0, other: 0 });

                    totals.shipping += adj.shipping || 0;
                    totals.proption += adj.proption || 0;
                    totals.other += adj.other || 0;
                    const totalAdjustment = adj.adjustment || 0;
                    
                    const profit = totals.sales - totals.commission - totals.shipping - totals.ads - totals.proption - totals.cost - totals.other + totalAdjustment;
                    const profitRate = totals.sales > 0 ? (profit / totals.sales * 100).toFixed(1) : 0;

                    rows.push({
                        year: parseInt(year),
                        monthNum: parseInt(month.replace('æœˆ', '')),
                        yearMonth: `${year}å¹´${month}`,
                        ...totals,
                        adjustment: totalAdjustment,
                        profit,
                        profitRate
                    });
                }
            }

            rows.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.monthNum - a.monthNum;
            });

            tbody.innerHTML = rows.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${r.yearMonth}</td>
                    <td class="p-3 text-right font-semibold">${formatCurrency(r.sales)}</td>
                    <td class="p-3 text-right text-red-600">${formatCurrency(r.commission)}</td>
                    <td class="p-3 text-right text-red-600">${formatCurrency(r.shipping)}</td>
                    <td class="p-3 text-right text-red-600">${formatCurrency(r.ads)}</td>
                    <td class="p-3 text-right text-red-600">${formatCurrency(r.proption)}</td>
                    <td class="p-3 text-right text-red-600">${formatCurrency(r.cost)}</td>
                    <td class="p-3 text-right">${formatCurrency(r.other)}</td>
                    <td class="p-3 text-right">${formatCurrency(r.adjustment)}</td>
                    <td class="p-3 text-right font-bold ${r.profit >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(r.profit)}</td>
                    <td class="p-3 text-right ${r.profitRate >= 0 ? 'text-blue-600' : 'text-red-600'}">${r.profitRate}%</td>
                </tr>
            `).join('');
        }

        let profitChart = null;

        function updateGraph() {
            const ctx = document.getElementById('profitChart');
            const rows = [];

            for (let year in monthlyData) {
                for (let month in monthlyData[year]) {
                    const products = monthlyData[year][month];
                    const adj = getAdjustments(year, month);
                    
                    const totals = products.reduce((acc, p) => ({
                        sales: acc.sales + (p.sales || 0),
                        commission: acc.commission + (p.commission || 0),
                        shipping: acc.shipping + (p.shipping || 0),
                        ads: acc.ads + (p.ads || 0),
                        proption: acc.proption + (p.proption || 0),
                        cost: acc.cost + (p.cost || 0),
                        other: acc.other + (p.other || 0)
                    }), { sales: 0, commission: 0, shipping: 0, ads: 0, proption: 0, cost: 0, other: 0 });

                    totals.shipping += adj.shipping || 0;
                    totals.proption += adj.proption || 0;
                    totals.other += adj.other || 0;
                    const totalAdjustment = adj.adjustment || 0;
                    
                    const profit = totals.sales - totals.commission - totals.shipping - totals.ads - totals.proption - totals.cost - totals.other + totalAdjustment;

                    rows.push({
                        year: parseInt(year),
                        monthNum: parseInt(month.replace('æœˆ', '')),
                        label: `${year}/${month.replace('æœˆ', '')}`,
                        sales: totals.sales,
                        profit: profit
                    });
                }
            }

            rows.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.monthNum - b.monthNum;
            });

            if (profitChart) {
                profitChart.destroy();
            }

            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rows.map(r => r.label),
                    datasets: [
                        {
                            label: 'å£²ä¸Š',
                            data: rows.map(r => r.sales),
                            backgroundColor: 'rgba(255, 140, 0, 0.5)',
                            borderColor: 'rgba(255, 140, 0, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'åˆ©ç›Š',
                            data: rows.map(r => r.profit),
                            type: 'line',
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å£²ä¸Š (å††)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'åˆ©ç›Š (å††)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        }

        function updateRanking() {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];

            const salesRanking = [...products]
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);

            const profitRanking = [...products]
                .map(p => ({
                    ...p,
                    profit: p.sales - p.commission - p.shipping - p.ads - (p.proption || 0) - p.cost - (p.other || 0)
                }))
                .sort((a, b) => b.profit - a.profit)
                .slice(0, 10);

            document.getElementById('salesRanking').innerHTML = salesRanking.map((p, i) => `
                <div class="flex items-center gap-3 py-2 border-b">
                    <div class="text-2xl font-bold text-gray-400 w-8">${i + 1}</div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.id}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-orange-600">${formatCurrency(p.sales)}</div>
                        <div class="text-xs text-gray-500">${p.quantity}å€‹</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('profitRanking').innerHTML = profitRanking.map((p, i) => `
                <div class="flex items-center gap-3 py-2 border-b">
                    <div class="text-2xl font-bold text-gray-400 w-8">${i + 1}</div>
                    <div class="flex-1">
                        <div class="font-semibold text-sm">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.id}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${p.profit >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(p.profit)}</div>
                        <div class="text-xs text-gray-500">${p.sales > 0 ? (p.profit/p.sales*100).toFixed(1) : 0}%</div>
                    </div>
                </div>
            `).join('');
        }

        function updateComparison() {
            const currentSales = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth])
                ? monthlyData[currentYear][currentMonth].reduce((sum, p) => sum + p.sales, 0)
                : 0;

            const lastYear = (parseInt(currentYear) - 1).toString();
            const lastYearSales = (monthlyData[lastYear] && monthlyData[lastYear][currentMonth])
                ? monthlyData[lastYear][currentMonth].reduce((sum, p) => sum + p.sales, 0)
                : 0;

            const monthNum = parseInt(currentMonth.replace('æœˆ', ''));
            const lastMonthNum = monthNum === 1 ? 12 : monthNum - 1;
            const lastMonthYear = monthNum === 1 ? (parseInt(currentYear) - 1).toString() : currentYear;
            const lastMonthStr = lastMonthNum + 'æœˆ';
            const lastMonthSales = (monthlyData[lastMonthYear] && monthlyData[lastMonthYear][lastMonthStr])
                ? monthlyData[lastMonthYear][lastMonthStr].reduce((sum, p) => sum + p.sales, 0)
                : 0;

            if (lastYearSales > 0 || lastMonthSales > 0) {
                document.getElementById('comparisonSection').style.display = 'block';
                
                document.getElementById('lastYearSales').textContent = formatCurrency(lastYearSales);
                const lyChange = lastYearSales > 0 ? ((currentSales - lastYearSales) / lastYearSales * 100).toFixed(1) : 0;
                document.getElementById('lastYearComparison').textContent = `(${lyChange >= 0 ? '+' : ''}${lyChange}%)`;
                document.getElementById('lastYearComparison').className = lyChange >= 0 ? 'text-sm text-blue-600' : 'text-sm text-red-600';

                document.getElementById('lastMonthSales').textContent = formatCurrency(lastMonthSales);
                const lmChange = lastMonthSales > 0 ? ((currentSales - lastMonthSales) / lastMonthSales * 100).toFixed(1) : 0;
                document.getElementById('lastMonthComparison').textContent = `(${lmChange >= 0 ? '+' : ''}${lmChange}%)`;
                document.getElementById('lastMonthComparison').className = lmChange >= 0 ? 'text-sm text-blue-600' : 'text-sm text-red-600';
            }
        }

        function formatCurrency(value) {
            return 'Â¥' + Math.round(value).toLocaleString();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-orange-600', 'text-white');
        }

        function sortTable(column) {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            products.sort((a, b) => {
                if (column === 'sales') return b.sales - a.sales;
                if (column === 'quantity') return b.quantity - a.quantity;
                if (column === 'price') {
                    const priceA = a.quantity > 0 ? a.sales / a.quantity : 0;
                    const priceB = b.quantity > 0 ? b.sales / b.quantity : 0;
                    return priceB - priceA;
                }
                if (column === 'access') return (b.access || 0) - (a.access || 0);
                if (column === 'profit') {
                    const profitA = a.sales - a.commission - a.shipping - a.ads - (a.proption || 0) - a.cost - (a.other || 0);
                    const profitB = b.sales - b.commission - b.shipping - b.ads - (b.proption || 0) - b.cost - (b.other || 0);
                    return profitB - profitA;
                }
            });

            updateProductsTable();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function openUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadModal').classList.add('flex');
            
            const now = new Date();
            document.getElementById('salesYear').value = now.getFullYear();
            document.getElementById('salesMonth').value = now.getMonth() + 1;
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
        }

        function clearUploadFiles() {
            document.getElementById('salesFile').value = '';
            document.getElementById('adsFile').value = '';
            document.getElementById('costFile').value = '';
            console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        function openCostEditModal() {
            document.getElementById('costEditModal').classList.remove('hidden');
            document.getElementById('costEditModal').classList.add('flex');
            updateCostEditTable();
        }

        function closeCostEditModal() {
            document.getElementById('costEditModal').classList.add('hidden');
            document.getElementById('costEditModal').classList.remove('flex');
        }

        function updateCostEditTable() {
            const searchTerm = document.getElementById('costSearchInput').value.toLowerCase();
            const tbody = document.getElementById('costEditTable');
            
            const allProducts = [];
            for (let code in rawData.cost) {
                allProducts.push({
                    id: code,
                    name: rawData.cost[code].name || '',
                    cost: rawData.cost[code].cost || 0,
                    shipping: rawData.cost[code].shipping || 0
                });
            }

            const filtered = allProducts.filter(p => 
                p.id.toLowerCase().includes(searchTerm) || 
                p.name.toLowerCase().includes(searchTerm)
            );

            tbody.innerHTML = filtered.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${p.id}</td>
                    <td class="p-3">${p.name}</td>
                    <td class="p-3 text-right">
                        <input type="number" value="${p.cost}" 
                               onchange="updateCostValue('${p.id}', 'cost', this.value)"
                               class="w-24 px-2 py-1 border rounded text-right">
                    </td>
                    <td class="p-3 text-right">
                        <input type="number" value="${p.shipping}" 
                               onchange="updateCostValue('${p.id}', 'shipping', this.value)"
                               class="w-24 px-2 py-1 border rounded text-right">
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="saveCostEdit('${p.id}')" 
                                class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                            ä¿å­˜
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCostValue(id, field, value) {
            if (!rawData.cost[id]) rawData.cost[id] = {};
            rawData.cost[id][field] = parseFloat(value) || 0;
        }

        function saveCostEdit(id) {
            recalculateAllMonths();
            saveToStorage();
            updateDisplay();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }

        document.getElementById('costSearchInput').addEventListener('input', updateCostEditTable);

        async function processUpload() {
            const salesFile = document.getElementById('salesFile').files[0];
            const adsFile = document.getElementById('adsFile').files[0];
            const costFile = document.getElementById('costFile').files[0];

            const year = document.getElementById('salesYear').value;
            const monthNum = document.getElementById('salesMonth').value;
            const month = monthNum + 'æœˆ';

            if (!salesFile) {
                alert('å£²ä¸ŠCSVã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ç¢ºèª
            if (monthlyData[year] && monthlyData[year][month]) {
                if (!confirm(`${year}å¹´${month}ã®ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\nä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            }

            try {
                // å£²ä¸ŠCSVã®èª­ã¿è¾¼ã¿
                const salesData = await readCSV(salesFile, 'shift-jis');
                const salesProducts = {};
                
                console.log('å£²ä¸ŠCSVèª­ã¿è¾¼ã¿é–‹å§‹:', salesData.length + 'è¡Œ');
                
                // Cåˆ—ï¼ˆã‚µãƒ–ã‚³ãƒ¼ãƒ‰ï¼‰ãŒç©ºæ¬„ã®è¡Œã®ã¿ã‚’æŠ½å‡ºï¼ˆé›†ç´„ãƒ‡ãƒ¼ã‚¿ï¼‰
                let aggregateCount = 0;
                let skippedCount = 0;
                
                salesData.forEach((row, index) => {
                    const productCode = (row['å•†å“ã‚³ãƒ¼ãƒ‰'] || '').trim();
                    const subCode = (row['ã‚µãƒ–ã‚³ãƒ¼ãƒ‰'] || '').trim();
                    const sales = parseFloat(row['å£²ä¸Šåˆè¨ˆå€¤(ç¨è¾¼)'] || row['å£²ä¸Šåˆè¨ˆå€¤ï¼ˆç¨è¾¼ï¼‰']) || 0;
                    const quantity = parseInt(row['æ³¨æ–‡æ•°åˆè¨ˆ']) || 0;
                    const purchaseRate = row['å¹³å‡è³¼è²·ç‡'];
                    const pv1 = parseInt(row['ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼(å„ªè‰¯é…é€ã‚ã‚Š)'] || row['ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ï¼ˆå„ªè‰¯é…é€ã‚ã‚Šï¼‰']) || 0;
                    const pv2 = parseInt(row['ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼(å„ªè‰¯é…é€ãªã—)'] || row['ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ï¼ˆå„ªè‰¯é…é€ãªã—ï¼‰']) || 0;
                    
                    // ã‚µãƒ–ã‚³ãƒ¼ãƒ‰ãŒç©ºæ¬„ã®è¡Œã®ã¿å‡¦ç†ï¼ˆé›†ç´„ãƒ‡ãƒ¼ã‚¿ï¼‰
                    if (!subCode && productCode) {
                        aggregateCount++;
                        
                        const avgPurchaseRate = (purchaseRate && purchaseRate !== 'é›†è¨ˆå¯¾è±¡å¤–') 
                            ? parseFloat(purchaseRate) 
                            : 0;
                        
                        salesProducts[productCode] = {
                            id: productCode,
                            productCode: productCode,
                            name: row['å•†å“å'],
                            sales: sales,
                            quantity: quantity,
                            purchaseRate: avgPurchaseRate,
                            access: pv1 + pv2,
                            commission: sales * COMMISSION_RATE,
                            shipping: 0,
                            ads: 0,
                            proption: 0,
                            cost: 0,
                            other: 0
                        };
                        
                        if (aggregateCount <= 5) {
                            console.log(`  é›†ç´„ãƒ‡ãƒ¼ã‚¿[${aggregateCount}]: "${productCode}" -> å£²ä¸Š=${sales}å††, æ³¨æ–‡æ•°=${quantity}`);
                        }
                    } else if (subCode) {
                        skippedCount++;
                    }
                });
                
                console.log(`å£²ä¸Šãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†:`);
                console.log(`  é›†ç´„è¡Œï¼ˆä½¿ç”¨ï¼‰: ${aggregateCount}ä»¶`);
                console.log(`  ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¡Œï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰: ${skippedCount}ä»¶`);

                // åºƒå‘Šè²»CSVã®èª­ã¿è¾¼ã¿
                if (adsFile) {
                    const adsData = await readCSV(adsFile, 'shift-jis');
                    console.log('åºƒå‘Šè²»CSVèª­ã¿è¾¼ã¿é–‹å§‹:', adsData.length + 'è¡Œ');
                    
                    let adsMatchCount = 0;
                    adsData.forEach(row => {
                        const productCode = (row['å•†å“ã‚³ãƒ¼ãƒ‰'] || '').trim();
                        const adCost = parseFloat(row['åˆ©ç”¨é‡‘é¡']) || 0;
                        
                        if (adCost > 0 && productCode) {
                            if (salesProducts[productCode]) {
                                salesProducts[productCode].ads += adCost;
                                adsMatchCount++;
                            }
                        }
                    });
                    console.log(`åºƒå‘Šè²»ãƒãƒƒãƒãƒ³ã‚°å®Œäº†: ${adsMatchCount}/${adsData.length}ä»¶`);
                }

                // åŸä¾¡CSVã®èª­ã¿è¾¼ã¿
                if (costFile) {
                    let costCount = 0;
                    console.log('åŸä¾¡ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹:', costFile.name);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‚’ãƒã‚§ãƒƒã‚¯
                    const fileName = costFile.name.toLowerCase();
                    let costDataArray = [];
                    
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        // Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
                        console.log('Excelå½¢å¼ã§èª­ã¿è¾¼ã¿ä¸­...');
                        const data = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsArrayBuffer(costFile);
                        });
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        console.log(`Excelèª­ã¿è¾¼ã¿å®Œäº†: ${jsonData.length}è¡Œ`);
                        
                        // é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
                        for (let i = 1; i < jsonData.length; i++) { // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                            const row = jsonData[i];
                            if (row && row.length > 21) {
                                const productCode = row[1] ? String(row[1]).trim() : '';
                                const name = row[3] ? String(row[3]).trim() : '';
                                const costValue = row[15];
                                const shippingValue = row[21];
                                
                                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚„ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                                if (productCode && productCode !== 'å•†å“ã‚³ãƒ¼ãƒ‰' && costValue !== undefined && costValue !== 'å•†å“å˜ä½“åŸä¾¡') {
                                    // æ•°å€¤å¤‰æ›ï¼ˆæ–‡å­—åˆ—ã®å ´åˆã¯ã‚«ãƒ³ãƒã‚’å‰Šé™¤ï¼‰
                                    const cost = typeof costValue === 'number' ? costValue : parseFloat(String(costValue).replace(/,/g, '')) || 0;
                                    const shipping = typeof shippingValue === 'number' ? shippingValue : parseFloat(String(shippingValue).replace(/,/g, '')) || 0;
                                    
                                    rawData.cost[productCode] = {
                                        cost: cost,
                                        shipping: shipping,
                                        name: name
                                    };
                                    costCount++;
                                    
                                    if (costCount <= 5) {
                                        console.log(`  åŸä¾¡ç™»éŒ²[${costCount}]: "${productCode}" -> åŸä¾¡=${cost}å††, é€æ–™=${shipping}å††`);
                                    }
                                }
                            }
                        }
                    } else {
                        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
                        console.log('CSVå½¢å¼ã§èª­ã¿è¾¼ã¿ä¸­...');
                        const costData = await readCSV(costFile, 'utf-8');
                        
                        costData.forEach((row, index) => {
                            const rowArray = Object.values(row);
                            if (rowArray.length > 21) {
                                const productCode = (rowArray[1] || '').trim();
                                const costStr = (rowArray[15] || '').trim();
                                const shippingStr = (rowArray[21] || '').trim();
                                const name = (rowArray[3] || '').trim();

                                if (productCode && productCode !== 'å•†å“ã‚³ãƒ¼ãƒ‰' && costStr && costStr !== 'å•†å“å˜ä½“åŸä¾¡') {
                                    const cost = parseFloat(costStr.replace(/,/g, '')) || 0;
                                    const shipping = parseFloat(shippingStr.replace(/,/g, '')) || 0;
                                    
                                    rawData.cost[productCode] = {
                                        cost: cost,
                                        shipping: shipping,
                                        name: name
                                    };
                                    costCount++;
                                    
                                    if (costCount <= 5) {
                                        console.log(`  åŸä¾¡ç™»éŒ²[${costCount}]: "${productCode}" -> åŸä¾¡=${cost}å††, é€æ–™=${shipping}å††`);
                                    }
                                }
                            }
                        });
                    }
                    
                    uploadStatus.cost = true;
                    document.getElementById('costStatus').textContent = 'âœ“ ä¿å­˜æ¸ˆã¿ (' + costCount + 'ä»¶)';
                    document.getElementById('costStatus').className = 'text-green-600 mt-2 text-sm';
                    console.log('åŸä¾¡ãƒ‡ãƒ¼ã‚¿ç™»éŒ²å®Œäº†:', costCount + 'ä»¶');
                    console.log('åŸä¾¡ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®10ä»¶ï¼‰:', Object.keys(rawData.cost).slice(0, 10));
                }

                // åŸä¾¡ãƒ»é€æ–™ã‚’å•†å“ã«åæ˜ 
                let matchedCount = 0;
                let unmatchedProducts = [];
                
                console.log('=== åŸä¾¡ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ ===');
                console.log('ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹åŸä¾¡ãƒ‡ãƒ¼ã‚¿æ•°:', Object.keys(rawData.cost).length);
                console.log('ãƒãƒƒãƒãƒ³ã‚°å¯¾è±¡å•†å“æ•°:', Object.keys(salesProducts).length);
                
                // åŸä¾¡ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
                const costSample = Object.keys(rawData.cost).slice(0, 5);
                console.log('åŸä¾¡ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', costSample);
                
                // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
                const salesSample = Object.keys(salesProducts).slice(0, 5);
                console.log('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', salesSample);
                
                for (let productCode in salesProducts) {
                    const product = salesProducts[productCode];
                    
                    if (rawData.cost[productCode]) {
                        const costPerUnit = rawData.cost[productCode].cost || 0;
                        const shippingPerUnit = rawData.cost[productCode].shipping || 0;
                        product.cost = costPerUnit * product.quantity;
                        product.shipping = shippingPerUnit * product.quantity;
                        matchedCount++;
                        
                        if (matchedCount <= 5) {
                            console.log(`âœ“ ãƒãƒƒãƒãƒ³ã‚°[${matchedCount}]: "${productCode}" -> å˜ä¾¡:åŸä¾¡=${costPerUnit}å††/é€æ–™=${shippingPerUnit}å†† Ã— æ•°é‡${product.quantity} = åŸä¾¡${product.cost}å††/é€æ–™${product.shipping}å††`);
                        }
                    } else {
                        unmatchedProducts.push(productCode);
                        if (unmatchedProducts.length <= 5) {
                            console.log(`âœ— ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—: "${productCode}" (åŸä¾¡ãƒ‡ãƒ¼ã‚¿ãªã—)`);
                        }
                    }
                }
                
                console.log(`=== ãƒãƒƒãƒãƒ³ã‚°çµæœ: ${matchedCount}/${Object.keys(salesProducts).length}ä»¶ æˆåŠŸ (${(matchedCount/Object.keys(salesProducts).length*100).toFixed(1)}%) ===`);
                if (unmatchedProducts.length > 0) {
                    console.log(`ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—: ${unmatchedProducts.length}ä»¶`);
                    console.log('å¤±æ•—ã—ãŸå•†å“ã‚³ãƒ¼ãƒ‰ï¼ˆæœ€åˆã®10ä»¶ï¼‰:', unmatchedProducts.slice(0, 10));
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                if (!monthlyData[year]) monthlyData[year] = {};
                monthlyData[year][month] = Object.values(salesProducts);

                await saveToStorage();
                
                closeUploadModal();
                currentYear = year;
                currentMonth = month;
                document.getElementById('headerYear').textContent = year + 'å¹´';
                document.getElementById('headerMonth').textContent = month;
                document.getElementById('yearSelect').value = year;
                
                initMonthSelector();
                updateDisplay();
                updateComparison();
                
                alert(`${year}å¹´${month}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ\nå•†å“æ•°: ${Object.keys(salesProducts).length}ä»¶`);
            } catch (error) {
                console.error('Error:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function readCSV(file, encoding = 'utf-8') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        if (lines.length === 0) {
                            reject(new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™'));
                            return;
                        }
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').replace(/\r/g, ''));
                        const data = [];

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, '').replace(/\r/g, ''));
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                        console.log(`CSVèª­ã¿è¾¼ã¿æˆåŠŸ: ${data.length}è¡Œ, ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: ${encoding}`);
                        console.log('ãƒ˜ãƒƒãƒ€ãƒ¼:', headers);
                        resolve(data);
                    } catch (error) {
                        console.error('CSVè§£æã‚¨ãƒ©ãƒ¼:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                
                if (encoding === 'shift-jis') {
                    reader.readAsText(file, 'Shift_JIS');
                } else {
                    reader.readAsText(file, encoding);
                }
            });
        }

        function recalculateAllMonths() {
            for (let year in monthlyData) {
                for (let month in monthlyData[year]) {
                    monthlyData[year][month].forEach(product => {
                        const productCode = product.productCode.trim();
                        if (rawData.cost[productCode]) {
                            const costPerUnit = rawData.cost[productCode].cost || 0;
                            const shippingPerUnit = rawData.cost[productCode].shipping || 0;
                            product.cost = costPerUnit * product.quantity;
                            product.shipping = shippingPerUnit * product.quantity;
                        }
                    });
                }
            }
        }

        function generateMonthlyReport() {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            if (products.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const adj = getAdjustments(currentYear, currentMonth);
            const totals = products.reduce((acc, p) => ({
                sales: acc.sales + (p.sales || 0),
                commission: acc.commission + (p.commission || 0),
                shipping: acc.shipping + (p.shipping || 0),
                ads: acc.ads + (p.ads || 0),
                proption: acc.proption + (p.proption || 0),
                cost: acc.cost + (p.cost || 0),
                other: acc.other + (p.other || 0)
            }), { sales: 0, commission: 0, shipping: 0, ads: 0, proption: 0, cost: 0, other: 0 });

            totals.shipping += adj.shipping || 0;
            totals.proption += adj.proption || 0;
            totals.other += adj.other || 0;
            const totalAdjustment = adj.adjustment || 0;
            const profit = totals.sales - totals.commission - totals.shipping - totals.ads - totals.proption - totals.cost - totals.other + totalAdjustment;

            let csv = 'é …ç›®,é‡‘é¡,å‰²åˆ\n';
            csv += `å£²ä¸Š,${Math.round(totals.sales)},100.0%\n`;
            csv += `æ‰‹æ•°æ–™,${Math.round(totals.commission)},${(totals.commission/totals.sales*100).toFixed(1)}%\n`;
            csv += `é€æ–™,${Math.round(totals.shipping)},${(totals.shipping/totals.sales*100).toFixed(1)}%\n`;
            csv += `åºƒå‘Šè²»,${Math.round(totals.ads)},${(totals.ads/totals.sales*100).toFixed(1)}%\n`;
            csv += `PRã‚ªãƒ—ã‚·ãƒ§ãƒ³,${Math.round(totals.proption)},${(totals.proption/totals.sales*100).toFixed(1)}%\n`;
            csv += `ä»•å…¥åŸä¾¡,${Math.round(totals.cost)},${(totals.cost/totals.sales*100).toFixed(1)}%\n`;
            csv += `ãã®ä»–,${Math.round(totals.other)},${(totals.other/totals.sales*100).toFixed(1)}%\n`;
            csv += `èª¿æ•´é¡,${Math.round(totalAdjustment)},${(totalAdjustment/totals.sales*100).toFixed(1)}%\n`;
            csv += `åˆ©ç›Š,${Math.round(profit)},${(profit/totals.sales*100).toFixed(1)}%\n`;

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Yahooæœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_${currentYear}å¹´${currentMonth}.csv`;
            link.click();
        }

        function exportProductData() {
            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            if (products.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let csv = 'å•†å“ã‚³ãƒ¼ãƒ‰,å•†å“å,å£²ä¸Š,æ³¨æ–‡æ•°,æ‰‹æ•°æ–™,é€æ–™,åºƒå‘Šè²»,ä»•å…¥åŸä¾¡,ãã®ä»–,åˆ©ç›Š,åˆ©ç›Šç‡,åºƒå‘ŠæŠœãåˆ©ç›Šç‡\n';
            products.forEach(p => {
                const profit = p.sales - p.commission - p.shipping - p.ads - (p.proption || 0) - p.cost - (p.other || 0);
                const profitRate = p.sales > 0 ? (profit / p.sales * 100).toFixed(1) : 0;
                const profitWithoutAds = p.sales - p.commission - p.shipping - p.cost - (p.other || 0);
                const profitRateWithoutAds = p.sales > 0 ? (profitWithoutAds / p.sales * 100).toFixed(1) : 0;
                csv += `${p.id},"${p.name}",${Math.round(p.sales)},${p.quantity},${Math.round(p.commission)},${Math.round(p.shipping)},${Math.round(p.ads)},${Math.round(p.cost)},${Math.round(p.other || 0)},${Math.round(profit)},${profitRate}%,${profitRateWithoutAds}%\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Yahooå•†å“ãƒ‡ãƒ¼ã‚¿_${currentYear}å¹´${currentMonth}.csv`;
            link.click();
        }

        async function saveToStorage() {
            try {
                if (window.storage) {
                    await window.storage.set('yahoo-monthly-data', JSON.stringify(monthlyData));
                    await window.storage.set('yahoo-raw-data', JSON.stringify(rawData));
                    await window.storage.set('yahoo-adjustments', JSON.stringify(adjustments));
                    await window.storage.set('yahoo-upload-status', JSON.stringify(uploadStatus));
                    console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†ï¼ˆwindow.storageï¼‰');
                } else {
                    throw new Error('window.storage not available');
                }
            } catch (error) {
                console.log('window.storageã§ã®ä¿å­˜å¤±æ•—ã€localStorageã‚’ä½¿ç”¨:', error);
                localStorage.setItem('yahoo-monthly-data', JSON.stringify(monthlyData));
                localStorage.setItem('yahoo-raw-data', JSON.stringify(rawData));
                localStorage.setItem('yahoo-adjustments', JSON.stringify(adjustments));
                localStorage.setItem('yahoo-upload-status', JSON.stringify(uploadStatus));
                console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†ï¼ˆlocalStorageï¼‰');
            }
        }

        async function loadFromStorage() {
            try {
                if (window.storage) {
                    console.log('window.storageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                    const monthlyResult = await window.storage.get('yahoo-monthly-data');
                    if (monthlyResult && monthlyResult.value) {
                        monthlyData = JSON.parse(monthlyResult.value);
                        console.log('æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                    }

                    const rawResult = await window.storage.get('yahoo-raw-data');
                    if (rawResult && rawResult.value) {
                        rawData = JSON.parse(rawResult.value);
                        console.log('åŸä¾¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', Object.keys(rawData.cost).length + 'ä»¶');
                    }

                    const adjustResult = await window.storage.get('yahoo-adjustments');
                    if (adjustResult && adjustResult.value) {
                        adjustments = JSON.parse(adjustResult.value);
                    }

                    const statusResult = await window.storage.get('yahoo-upload-status');
                    if (statusResult && statusResult.value) {
                        uploadStatus = JSON.parse(statusResult.value);
                        if (uploadStatus.cost) {
                            document.getElementById('costStatus').textContent = 'âœ“ ä¿å­˜æ¸ˆã¿';
                            document.getElementById('costStatus').className = 'text-green-600 mt-2 text-sm';
                        }
                    }
                    
                    console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆwindow.storageï¼‰');
                } else {
                    throw new Error('window.storage not available');
                }
            } catch (error) {
                console.log('window.storageã§ã®èª­ã¿è¾¼ã¿å¤±æ•—ã€localStorageã‚’ä½¿ç”¨:', error);
                
                try {
                    const savedMonthly = localStorage.getItem('yahoo-monthly-data');
                    const savedRaw = localStorage.getItem('yahoo-raw-data');
                    const savedAdjust = localStorage.getItem('yahoo-adjustments');
                    const savedStatus = localStorage.getItem('yahoo-upload-status');
                    
                    if (savedMonthly) monthlyData = JSON.parse(savedMonthly);
                    if (savedRaw) {
                        rawData = JSON.parse(savedRaw);
                        console.log('åŸä¾¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸï¼ˆlocalStorageï¼‰:', Object.keys(rawData.cost).length + 'ä»¶');
                    }
                    if (savedAdjust) adjustments = JSON.parse(savedAdjust);
                    if (savedStatus) {
                        uploadStatus = JSON.parse(savedStatus);
                        if (uploadStatus.cost) {
                            document.getElementById('costStatus').textContent = 'âœ“ ä¿å­˜æ¸ˆã¿';
                            document.getElementById('costStatus').className = 'text-green-600 mt-2 text-sm';
                        }
                    }
                    
                    console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆlocalStorageï¼‰');
                } catch (localError) {
                    console.error('localStorageèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', localError);
                }
            }
            
            selectMonth(currentMonth);
        }

        document.getElementById('searchInput').addEventListener('input', updateProductsTable);

        function toggleEditMode(type) {
            const labels = {
                shipping: 'é€æ–™èª¿æ•´é¡',
                proption: 'PRã‚ªãƒ—ã‚·ãƒ§ãƒ³èª¿æ•´é¡',
                affiliate: 'ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆèª¿æ•´é¡',
                other: 'å€‰åº«ä¿ç®¡æ–™ç­‰èª¿æ•´é¡',
                adjustment: 'èª¿æ•´é¡'
            };
            const adj = getAdjustments(currentYear, currentMonth);
            const value = prompt(`${currentYear}å¹´${currentMonth}ã®${labels[type]}ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, adj[type] || 0);
            if (value !== null) {
                adj[type] = parseFloat(value) || 0;
                saveToStorage();
                updateDisplay();
                updateComparison();
            }
        }

        // å€‹åˆ¥ã®èª¿æ•´é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
        function adjustShipping() { toggleEditMode('shipping'); }
        function adjustProption() { toggleEditMode('proption'); }
        function adjustAffiliate() { toggleEditMode('affiliate'); }
        function adjustOtherExpense() { toggleEditMode('other'); }
        function adjustAdjustment() { toggleEditMode('adjustment'); }

        document.getElementById('yearSelect').addEventListener('change', function() {
            currentYear = this.value;
            document.getElementById('headerYear').textContent = currentYear + 'å¹´';
            selectMonth(currentMonth);
        });

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        async function resetAllData() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                monthlyData = {};
                rawData = {
                    sales: {},
                    ads: {},
                    cost: {}
                };
                adjustments = {};
                uploadStatus = {
                    sales: false,
                    ads: false,
                    cost: false
                };

                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                if (window.storage) {
                    await window.storage.delete('yahoo-monthly-data');
                    await window.storage.delete('yahoo-raw-data');
                    await window.storage.delete('yahoo-adjustments');
                    await window.storage.delete('yahoo-upload-status');
                } else {
                    localStorage.removeItem('yahoo-monthly-data');
                    localStorage.removeItem('yahoo-raw-data');
                    localStorage.removeItem('yahoo-adjustments');
                    localStorage.removeItem('yahoo-upload-status');
                }

                // UIã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('costStatus').textContent = 'æœªç™»éŒ²';
                document.getElementById('costStatus').className = 'mt-2 text-sm';
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay();
                updateComparison();
                
                alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openBackupModal() {
            document.getElementById('backupModal').classList.remove('hidden');
            document.getElementById('backupModal').classList.add('flex');
        }

        function closeBackupModal() {
            document.getElementById('backupModal').classList.add('hidden');
            document.getElementById('backupModal').classList.remove('flex');
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadBackup() {
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                monthlyData: monthlyData,
                rawData: rawData,
                adjustments: adjustments,
                uploadStatus: uploadStatus
            };

            const json = JSON.stringify(backupData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `yahoo_profit_backup_${dateStr}.json`;
            link.click();
            
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ
        async function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const text = await file.text();
                const backupData = JSON.parse(text);

                // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                monthlyData = backupData.monthlyData || {};
                rawData = backupData.rawData || { sales: {}, ads: {}, cost: {} };
                adjustments = backupData.adjustments || {};
                uploadStatus = backupData.uploadStatus || { sales: false, ads: false, cost: false };

                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                await saveToStorage();

                // UIã‚’æ›´æ–°
                if (uploadStatus.cost) {
                    const costCount = Object.keys(rawData.cost).length;
                    document.getElementById('costStatus').textContent = 'âœ“ ä¿å­˜æ¸ˆã¿ (' + costCount + 'ä»¶)';
                    document.getElementById('costStatus').className = 'text-green-600 mt-2 text-sm';
                }

                updateDisplay();
                updateComparison();

                closeBackupModal();
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function openSpreadsheetModal() {
            document.getElementById('spreadsheetModal').classList.remove('hidden');
            document.getElementById('spreadsheetModal').classList.add('flex');
            
            // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹URL ã‚’èª­ã¿è¾¼ã¿
            const savedUrl = localStorage.getItem('yahoo-gas-url');
            if (savedUrl) {
                document.getElementById('gasUrl').value = savedUrl;
                document.getElementById('gasUrlStatus').textContent = 'âœ“ URLè¨­å®šæ¸ˆã¿';
                document.getElementById('gasUrlStatus').className = 'text-green-600 mt-2 text-sm';
            }
        }

        function closeSpreadsheetModal() {
            document.getElementById('spreadsheetModal').classList.add('hidden');
            document.getElementById('spreadsheetModal').classList.remove('flex');
        }

        // GAS URL ã‚’ä¿å­˜
        function saveGasUrl() {
            const url = document.getElementById('gasUrl').value.trim();
            if (!url) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!url.startsWith('https://script.google.com/macros/s/')) {
                alert('æ­£ã—ã„Google Apps Scriptã®Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            localStorage.setItem('yahoo-gas-url', url);
            document.getElementById('gasUrlStatus').textContent = 'âœ“ URLä¿å­˜å®Œäº†';
            document.getElementById('gasUrlStatus').className = 'text-green-600 mt-2 text-sm';
            alert('URLã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ä¿å­˜
        async function saveToSpreadsheet() {
            console.log('=== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜é–‹å§‹ ===');
            
            const gasUrl = localStorage.getItem('yahoo-gas-url');
            console.log('GAS URL:', gasUrl);
            
            if (!gasUrl) {
                alert('å…ˆã«GAS Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            const products = (monthlyData[currentYear] && monthlyData[currentYear][currentMonth]) 
                             ? monthlyData[currentYear][currentMonth] 
                             : [];
            
            console.log('ç¾åœ¨ã®å¹´æœˆ:', currentYear, currentMonth);
            console.log('å•†å“æ•°:', products.length);
            console.log('æœ€åˆã®3å•†å“:', products.slice(0, 3));
            
            if (products.length === 0) {
                alert(`${currentYear}å¹´${currentMonth}ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`);
                return;
            }

            if (!confirm(`${currentYear}å¹´${currentMonth}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nå•†å“æ•°: ${products.length}ä»¶`)) {
                return;
            }

            try {
                const monthNumber = currentMonth.replace('æœˆ', '');
                const adj = getAdjustments(currentYear, currentMonth);
                
                const dataToSave = {
                    yearMonth: `${currentYear}/${monthNumber}`,
                    products: products.map(p => ({
                        code: p.id || p.productCode,
                        name: p.name,
                        sales: Math.round(p.sales),
                        quantity: p.quantity,
                        commission: Math.round(p.commission),
                        shipping: Math.round(p.shipping),
                        ads: Math.round(p.ads),
                        cost: Math.round(p.cost),
                        other: Math.round(p.other || 0)
                    })),
                    adjustments: adj
                };

                console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', {
                    yearMonth: dataToSave.yearMonth,
                    productsCount: dataToSave.products.length,
                    firstProduct: dataToSave.products[0]
                });
                console.log('é€ä¿¡JSON:', JSON.stringify(dataToSave).substring(0, 500) + '...');

                const response = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });

                console.log('é€ä¿¡å®Œäº†');
                alert(`${currentYear}å¹´${currentMonth}ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã—ã¾ã—ãŸï¼\nå•†å“æ•°: ${products.length}ä»¶\n\næ•°ç§’å¾Œã«ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¿
        async function loadFromSpreadsheet() {
            const gasUrl = localStorage.getItem('yahoo-gas-url');
            if (!gasUrl) {
                alert('å…ˆã«GAS Webã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            const year = document.getElementById('loadYear').value;
            const monthNum = document.getElementById('loadMonth').value;
            const month = monthNum + 'æœˆ';

            if (!confirm(`ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰${year}å¹´${month}ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`${gasUrl}?year=${year}&month=${monthNum}`, {
                    method: 'GET'
                });

                const data = await response.json();
                
                if (!data || !data.products || data.products.length === 0) {
                    alert(`${year}å¹´${month}ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                    return;
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
                if (!monthlyData[year]) monthlyData[year] = {};
                
                monthlyData[year][month] = data.products.map(p => ({
                    id: p.code,
                    productCode: p.code,
                    name: p.name,
                    sales: p.sales,
                    quantity: p.quantity,
                    commission: p.commission,
                    shipping: p.shipping,
                    ads: p.ads,
                    cost: p.cost,
                    other: p.other || 0,
                    proption: 0,
                    access: 0
                }));

                if (data.adjustments) {
                    if (!adjustments[year]) adjustments[year] = {};
                    adjustments[year][month] = data.adjustments;
                }

                await saveToStorage();

                currentYear = year;
                currentMonth = month;
                document.getElementById('headerYear').textContent = year + 'å¹´';
                document.getElementById('headerMonth').textContent = month;
                document.getElementById('yearSelect').value = year;

                initMonthSelector();
                updateDisplay();
                updateComparison();

                closeSpreadsheetModal();
                alert(`${year}å¹´${month}ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    </script>
</body>
</html>
